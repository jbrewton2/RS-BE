name: build-and-push-backend-to-govcloud-ecr

on:
  push:
    branches:
      - main
      - feat/**
      - fix/**
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

concurrency:
  group: css-mock-deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  AWS_REGION: us-gov-east-1
  AWS_ACCOUNT_ID: "354962495083"
  ECR_REPOSITORY: "css/css-backend"
  IMAGE_TAG_PREFIX: "aws-"
  EKS_CLUSTER_NAME: "launchpad-observer"

jobs:
  build_push:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug Git SHA
        shell: bash
        run: |
          set -euo pipefail
          echo "GITHUB_REF=${GITHUB_REF}"
          echo "GITHUB_SHA=${GITHUB_SHA}"
          echo "SHA7=${GITHUB_SHA::7}"
      - name: Configure AWS creds (GovCloud) for ECR via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws-us-gov:iam::354962495083:role/github-actions-css-backend-ecr
          aws-region: ${{ env.AWS_REGION }}
      - name: Login to ECR (GovCloud)
        shell: bash
        run: |
          set -euo pipefail
          REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          aws ecr get-login-password --region "${AWS_REGION}" \
            | docker login --username AWS --password-stdin "${REGISTRY}"

      - name: Compute image tag
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          SHA7="${GITHUB_SHA::7}"
          TAG="${IMAGE_TAG_PREFIX}${SHA7}"
          echo "image_tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "Computed TAG=${TAG}"

      - name: Build and push image
        shell: bash
        run: |
          set -euo pipefail
          REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          IMAGE="${REGISTRY}/${ECR_REPOSITORY}"
          TAG="${{ steps.meta.outputs.image_tag }}"

          echo "Building ${IMAGE}:${TAG}"
          docker build -t "css-backend:${TAG}" .
          docker tag "css-backend:${TAG}" "${IMAGE}:${TAG}"
          docker push "${IMAGE}:${TAG}"
          echo "Pushed: ${IMAGE}:${TAG}"

  deploy_css_mock:
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/feat/aws-govcloud-migration-v1'
    needs: build_push
    runs-on: [self-hosted, Windows, X64, css-mock]

    steps:
      - name: Checkout
        uses: actions/checkout@v4


      - name: Debug Git SHA (Windows)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          Write-Host "GITHUB_REF=$env:GITHUB_REF"
          Write-Host "GITHUB_SHA=$env:GITHUB_SHA"
          Write-Host ("SHA7=" + $env:GITHUB_SHA.Substring(0,7))