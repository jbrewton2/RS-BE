name: build-and-push-backend-to-govcloud-ecr

on:
  push:
    branches:
      - main
      - feat/aws-govcloud-migration-v1
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-gov-east-1
  AWS_ACCOUNT_ID: "354962495083"
  ECR_REPOSITORY: "css/css-backend"
  IMAGE_TAG_PREFIX: "aws-"

jobs:
  build_push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS creds (GovCloud) via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws-us-gov:iam::354962495083:role/github-actions-css-backend-ecr
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR (GovCloud)
        shell: bash
        run: |
          set -euo pipefail
          REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          aws ecr get-login-password --region "${AWS_REGION}" \
            | docker login --username AWS --password-stdin "${REGISTRY}"

      - name: Build and push image
        shell: bash
        run: |
          set -euo pipefail
          REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          IMAGE="${REGISTRY}/${ECR_REPOSITORY}"
          SHA7="${GITHUB_SHA::7}"
          TAG="${IMAGE_TAG_PREFIX}${SHA7}"

          echo "Building ${IMAGE}:${TAG}"
          docker build -t "css-backend:${TAG}" .
          docker tag "css-backend:${TAG}" "${IMAGE}:${TAG}"
          docker push "${IMAGE}:${TAG}"

          echo "Pushed: ${IMAGE}:${TAG}"
