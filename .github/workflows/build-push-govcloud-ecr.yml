name: build-and-push-backend-to-govcloud-ecr

on:
  push:
    branches:
      - main
      - feat/aws-govcloud-migration-v1
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-gov-east-1
  AWS_ACCOUNT_ID: "354962495083"
  ECR_REPOSITORY: "css/css-backend"
  IMAGE_TAG_PREFIX: "aws-"
  # TODO: set your real cluster name
  EKS_CLUSTER_NAME: "css-mock"   # <-- CHANGE ME if different

jobs:
  build_push:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS creds (GovCloud) via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws-us-gov:iam::354962495083:role/github-actions-css-backend-ecr
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR (GovCloud)
        shell: bash
        run: |
          set -euo pipefail
          REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          aws ecr get-login-password --region "${AWS_REGION}" \
            | docker login --username AWS --password-stdin "${REGISTRY}"

      - name: Build and push image
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          IMAGE="${REGISTRY}/${ECR_REPOSITORY}"
          SHA7="${GITHUB_SHA::7}"
          TAG="${IMAGE_TAG_PREFIX}${SHA7}"

          echo "image_tag=${TAG}" >> "$GITHUB_OUTPUT"

          echo "Building ${IMAGE}:${TAG}"
          docker build -t "css-backend:${TAG}" .
          docker tag "css-backend:${TAG}" "${IMAGE}:${TAG}"
          docker push "${IMAGE}:${TAG}"

          echo "Pushed: ${IMAGE}:${TAG}"

  deploy_css_mock:
    needs: build_push
    runs-on: [self-hosted, Windows, X64, css-mock]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS creds (GovCloud) via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws-us-gov:iam::354962495083:role/github-actions-css-backend-ecr
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to css-mock using repo script
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          cd "$env:GITHUB_WORKSPACE"

          $tag = "${{ needs.build_push.outputs.image_tag }}"
          Write-Host "Deploying ImageTag=$tag"
   
      - name: Configure kubeconfig for GovCloud EKS
        shell: pwsh
        run: |
          $ErrorActionPreference="Stop"
          $region  = "us-gov-east-1"
          $cluster = "<PUT_CLUSTER_NAME_HERE>"
          aws eks update-kubeconfig --name $cluster --region $region
          kubectl config current-context
          kubectl -n css-mock get deploy

          .\scripts\deploy-css-mock.ps1 -ImageTag $tag
