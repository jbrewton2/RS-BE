name: build-and-push-backend-to-govcloud-ecr

on:
  push:
    branches:
      - main
      - feat/aws-govcloud-migration-v1
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

concurrency:
  group: css-mock-deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  AWS_REGION: us-gov-east-1
  AWS_ACCOUNT_ID: "354962495083"
  ECR_REPOSITORY: "css/css-backend"
  IMAGE_TAG_PREFIX: "aws-"
  EKS_CLUSTER_NAME: "launchpad-observer"

jobs:
  build_push:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug Git SHA
        shell: bash
        run: |
          set -euo pipefail
          echo "github.ref=${{ github.ref }}"
          echo "github.sha=${{ github.sha }}"
          SHA="${{ github.sha }}"
          echo "sha7=${SHA:0:7}"

      - name: Configure AWS creds (GovCloud) for ECR via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws-us-gov:iam::354962495083:role/github-actions-css-backend-ecr
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR (GovCloud)
        shell: bash
        run: |
          set -euo pipefail
          REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          aws ecr get-login-password --region "${AWS_REGION}" | docker login --username AWS --password-stdin "${REGISTRY}"

      - name: Compute image tag
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          SHA7="${GITHUB_SHA::7}"
          TAG="${IMAGE_TAG_PREFIX}${SHA7}"
          echo "image_tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "Computed TAG=${TAG}"

      - name: Build and push image
        shell: bash
        run: |
          set -euo pipefail
          REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          IMAGE="${REGISTRY}/${ECR_REPOSITORY}"
          TAG="${{ steps.meta.outputs.image_tag }}"
          echo "Building ${IMAGE}:${TAG}"
          docker build -t "css-backend:${TAG}" .
          docker tag "css-backend:${TAG}" "${IMAGE}:${TAG}"
          docker push "${IMAGE}:${TAG}"
          echo "Pushed: ${IMAGE}:${TAG}"

  deploy_css_mock:
    if: github.ref == 'refs/heads/main'
    needs: build_push
    runs-on: [self-hosted, Windows, X64, css-mock]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS creds (GovCloud) for EKS deploy via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws-us-gov:iam::354962495083:role/github-actions-css-backend-deploy
          aws-region: ${{ env.AWS_REGION }}

      - name: Update kubeconfig for EKS
        shell: pwsh
        run: |
          $ErrorActionPreference="Stop"
          aws sts get-caller-identity
          aws eks update-kubeconfig --name "${{ env.EKS_CLUSTER_NAME }}" --region "${{ env.AWS_REGION }}"
          kubectl config current-context
          kubectl -n css-mock get deploy

      - name: Deploy to css-mock using repo script
        shell: pwsh
        run: |
          $ErrorActionPreference="Stop"
          cd "$env:GITHUB_WORKSPACE"
          $tag = "${{ needs.build_push.outputs.image_tag }}"
          Write-Host "Deploy tag from build output: $tag"
          Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force
          .\scripts\deploy-css-mock.ps1 -ImageTag $tag

      - name: Post-deploy checks
        shell: pwsh
        run: |
          $ErrorActionPreference="Stop"
          kubectl -n css-mock get deploy css-backend -o jsonpath="{.spec.template.spec.containers[0].image}`n"
          kubectl -n css-mock rollout status deploy/css-backend
