﻿# IMPORTANT: Do NOT define top-level `stages:` in this GitLab environment.

smoke:
  image: alpine:3.20
  script:
    - echo "CI is alive for $CI_PROJECT_PATH on $CI_COMMIT_REF_NAME ($CI_PIPELINE_SOURCE)"

include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml

variables:
  SECRET_DETECTION_ENABLED: "true"
  SAST_EXCLUDED_PATHS: "**/__pycache__/**,**/.venv/**,**/venv/**,**/dist/**,**/build/**,**/*.min.js"
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2
  DOCKER_BUILDKIT: "1"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

# ---------------------------------------------
# ✅ Backend unit tests (pytest)
# ---------------------------------------------
pytest_backend:
  stage: test
  image: python:3.11-slim
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: on_success
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: on_success
    - if: '$CI_COMMIT_TAG'
      when: on_success
    - when: never
  cache:
    key: "pip-${CI_COMMIT_REF_SLUG}"
    paths:
      - .cache/pip
  variables:
    # Mimic Dockerfile behavior: repo is treated as the backend package root
    PYTHONPATH: "$CI_PROJECT_DIR"
  before_script:
    - python --version
    - python -m pip install --upgrade pip
    - pip install -r requirements.txt
    - pip install -U pytest
  script:
    - pytest -q --junitxml=report.xml
  artifacts:
    when: always
    reports:
      junit: report.xml
    expire_in: 7 days

# Optional: build/push backend container image (only MR/main/tags)
# Keep this ONLY if css-backend repo has a Dockerfile at repo root.
build_and_push_backend:
  stage: build
  image: docker:27
  services:
    - name: docker:27-dind
      command: ["--mtu=1460"]
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: on_success
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: on_success
    - if: '$CI_COMMIT_TAG'
      when: on_success
    - when: never
  script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    - export IMAGE="$CI_REGISTRY_IMAGE"
    - export SHA_TAG="sha-$CI_COMMIT_SHORT_SHA"
    - docker build --pull -t "$IMAGE:$SHA_TAG" .
    - docker push "$IMAGE:$SHA_TAG"
    - |
      if [ "$CI_COMMIT_BRANCH" = "main" ]; then
        docker tag "$IMAGE:$SHA_TAG" "$IMAGE:dev"
        docker push "$IMAGE:dev"
      fi
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        docker tag "$IMAGE:$SHA_TAG" "$IMAGE:prod"
        docker push "$IMAGE:prod"
        docker tag "$IMAGE:$SHA_TAG" "$IMAGE:$CI_COMMIT_TAG"
        docker push "$IMAGE:$CI_COMMIT_TAG"
      fi
